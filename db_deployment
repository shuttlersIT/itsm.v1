CREATE DATABASE itsm;

use itsm;

CREATE TABLE priority (
	id    INT AUTO_INCREMENT PRIMARY KEY,
	priority_name  VARCHAR(100) NOT NULL UNIQUE,
	first_response INT,
	colour   VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE satisfaction (
	id INT AUTO_INCREMENT PRIMARY KEY,
	satisfaction_name VARCHAR(100) NOT NULL UNIQUE,
	ranking INT NOT NULL,
	emoji VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE policy (
	id     INT AUTO_INCREMENT PRIMARY KEY,
	policy_name   VARCHAR(100) NOT NULL UNIQUE,
	embedded_link VARCHAR(255) NOT NULL,
	policy_url  VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE positions (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	position_name VARCHAR(150) NOT NULL UNIQUE,
	cadre_name    VARCHAR(150) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE departments (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	department_name VARCHAR(100) NOT NULL UNIQUE,
	emoji   VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE units (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	unit_name VARCHAR(100) NOT NULL UNIQUE,
	emoji   VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE roles (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	role_name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE category (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	category_name VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE attachments (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	short_link VARCHAR(255) NOT NULL,
	long_link TEXT,
	image BLOB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE asset_type (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	asset_type VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE sla (
	id          INT AUTO_INCREMENT PRIMARY KEY,
	sla_name        VARCHAR(100) NOT NULL UNIQUE,
	priority_id     INT,
	satisfaction_id INT,
	policy_id      INT,
	created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (priority_id) REFERENCES priority(id),
    FOREIGN KEY (satisfaction_id) REFERENCES satisfaction(id),
    FOREIGN KEY (policy_id) REFERENCES policy(id)
);

CREATE TABLE sub_category (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	sub_category_name VARCHAR(100) NOT NULL,
	category_id  INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES category(id)
);

CREATE TABLE staff_credentials (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	username VARCHAR(100) NOT NULL UNIQUE,
	password VARCHAR(100) NOT NULL,
	staff_id   INT NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE agent_credentials (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	username VARCHAR(100) NOT NULL UNIQUE,
	password VARCHAR(100) NOT NULL,
	agent_id   INT NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE staff (
	id INT AUTO_INCREMENT PRIMARY KEY,
	first_name    VARCHAR(100) NOT NULL,
	last_name     VARCHAR(100) NOT NULL,
	staff_email   VARCHAR(100) NOT NULL UNIQUE,
	phone VARCHAR(20) NOT NULL UNIQUE,
	username_id     INT UNIQUE,
	position_id   INT,
	department_id INT,
    FOREIGN KEY (position_id) REFERENCES positions(id),
    FOREIGN KEY (department_id) REFERENCES departments(id),
	FOREIGN KEY (username_id) REFERENCES staff_credentials(id)
);

CREATE TABLE agents (
	id INT AUTO_INCREMENT PRIMARY KEY,
	first_name  VARCHAR(100) NOT NULL,
	last_name   VARCHAR(100) NOT NULL,
	agent_email VARCHAR(20) NOT NULL UNIQUE,
	phone INT NOT NULL UNIQUE,
	username_id    INT UNIQUE,
	role_id     INT,
	unit_id     INT,
	supervisor_id INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (unit_id) REFERENCES units(id),
    FOREIGN KEY (supervisor_id) REFERENCES agents(id),
	FOREIGN KEY (username_id) REFERENCES agent_credentials(id)
);

CREATE TABLE assets (
	id            INT AUTO_INCREMENT PRIMARY KEY,
    asset_id      VARCHAR(100) NOT NULL,
	asset_type    VARCHAR(50) NOT NULL, 
	asset_name    VARCHAR(100) NOT NULL, 
	description   TEXT,
	manufacturer  VARCHAR(100) NOT NULL,
	model         VARCHAR(100) NOT NULL,
	serial_number VARCHAR(100) NOT NULL UNIQUE,
	purchase_date DATE,
	purchase_price INT,
	vendor VARCHAR(100),
	site VARCHAR(100),
	status VARCHAR(100) NOT NULL,
	created_by INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	FOREIGN KEY (created_by) REFERENCES agents(id)
);

CREATE TABLE asset_assignment (
	id   INT AUTO_INCREMENT PRIMARY KEY,
	asset_id INT NOT NULL UNIQUE,
	staff_id INT,
	assigned_by INT NOT NULL,
	assignment_type ENUM('buffer', 'permanent', 'temporary', 'lease'),
	due_at  DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	FOREIGN KEY (asset_id) REFERENCES assets(id),
    FOREIGN KEY (staff_id) REFERENCES staff(id),
	FOREIGN KEY (assigned_by) REFERENCES agents(id)
);

CREATE TABLE tickets (
	id INT AUTO_INCREMENT PRIMARY KEY,
	subject VARCHAR(255) NOT NULL,
	description TEXT,
	category_id INT,
	sub_category_id INT,
	priority_id INT,
	sla_id INT,
	staff_id INT,
	agent_id INT,
	created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	due_at  DATE,
	asset_id INT,
	related_ticket_id INT,
	tag   VARCHAR(50) NOT NULL,
	site  VARCHAR(50) NOT NULL,
    status ENUM('open', 'pending', 'in_progress', 'waiting for 3rd-Party-escalated', 'waiting for 3rd-Party-vendor', 'waiting for approval', 'waiting for feedback', 'closed'),
	attachment_id  INT,
    FOREIGN KEY (category_id) REFERENCES category(id),
    FOREIGN KEY (sub_category_id) REFERENCES sub_category(id),
    FOREIGN KEY (staff_id) REFERENCES staff(id),
    FOREIGN KEY (agent_id) REFERENCES agents(id),
    FOREIGN KEY (asset_id) REFERENCES assets(id),
    FOREIGN KEY (related_ticket_id) REFERENCES tickets(id),
    FOREIGN KEY (sla_id) REFERENCES sla(id),
    FOREIGN KEY (priority_id) REFERENCES priority(id),
    FOREIGN KEY (attachment_id) REFERENCES attachments(id)
);